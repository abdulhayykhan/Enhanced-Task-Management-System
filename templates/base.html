<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Task Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <!-- Notification Toast Container -->
  <div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
    <div id="notification-toast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <strong class="me-auto">Notification</strong>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" id="notification-message">
        <!-- Notification message will be inserted here -->
      </div>
    </div>
  </div>

  <div class="container py-4">
    <div class="text-center mb-4">
      <h1 class="display-4 fw-bold text-primary mb-3">Task Management System</h1>
      <div class="d-flex justify-content-center">
        <button id="darkToggle" class="btn btn-outline-secondary">🌙 Dark Mode</button>
      </div>
    </div>
    
    <!-- Notifications Alert -->
    <div id="notifications-alert" class="alert alert-info d-none">
      <div id="notifications-content"></div>
    </div>
    
    {% block content %}{% endblock %}
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Dark Mode Toggle -->
  <script>
    const body = document.body;
    const toggle = document.getElementById("darkToggle");
    const container = document.querySelector('.container');
    
    // Load saved theme
    const savedTheme = localStorage.getItem('darkMode');
    if (savedTheme === 'true') {
      enableDarkMode();
    }
    
    toggle.addEventListener("click", () => {
      if (body.classList.contains('bg-dark')) {
        disableDarkMode();
      } else {
        enableDarkMode();
      }
    });
    
    function enableDarkMode() {
      body.classList.add("bg-dark", "text-white");
      body.classList.remove("bg-light");
      toggle.innerHTML = "☀️ Light Mode";
      toggle.classList.remove("btn-outline-secondary");
      toggle.classList.add("btn-outline-light");
      
      // Update table styles
      const tables = document.querySelectorAll('.table');
      tables.forEach(table => {
        table.classList.add('table-dark');
      });
      
      // Update cards
      const cards = document.querySelectorAll('.card:not(.bg-success):not(.bg-warning):not(.bg-danger):not(.bg-info):not(.bg-secondary)');
      cards.forEach(card => {
        card.classList.add('bg-secondary', 'text-white');
      });
      
      localStorage.setItem('darkMode', 'true');
    }
    
    function disableDarkMode() {
      body.classList.remove("bg-dark", "text-white");
      body.classList.add("bg-light");
      toggle.innerHTML = "🌙 Dark Mode";
      toggle.classList.remove("btn-outline-light");
      toggle.classList.add("btn-outline-secondary");
      
      // Update table styles
      const tables = document.querySelectorAll('.table');
      tables.forEach(table => {
        table.classList.remove('table-dark');
      });
      
      // Update cards
      const cards = document.querySelectorAll('.card');
      cards.forEach(card => {
        if (!card.classList.contains('bg-success') && 
            !card.classList.contains('bg-warning') && 
            !card.classList.contains('bg-danger') && 
            !card.classList.contains('bg-info')) {
          card.classList.remove('bg-secondary', 'text-white');
        }
      });
      
      localStorage.setItem('darkMode', 'false');
    }
  </script>
  
  <!-- WebSocket for Real-time Notifications -->
  <script>
    {% if current_user %}
    const userId = {{ current_user.id }};
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws/${userId}`);
    
    ws.onmessage = function(event) {
      try {
        const notification = JSON.parse(event.data);
        showNotification(notification.message);
      } catch (e) {
        // Fallback for simple text messages
        showNotification(event.data);
      }
    };
    
    ws.onerror = function(error) {
      console.log('WebSocket error:', error);
    };
    
    ws.onclose = function() {
      console.log('WebSocket connection closed');
    };
    
    function showNotification(message) {
      const toastElement = document.getElementById('notification-toast');
      const messageElement = document.getElementById('notification-message');
      messageElement.textContent = message;
      
      const toast = new bootstrap.Toast(toastElement);
      toast.show();
    }
    {% endif %}
  </script>
</body>
</html>