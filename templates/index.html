{% extends "base.html" %}
{% block content %}
<!-- Enhanced Search and Filter Form -->
<div class="card mb-4 slide-in">
  <div class="card-body">
    <form method="get" id="search-form">
      <div class="row g-3">
        <div class="col-lg-5 col-md-6">
          <div class="input-group">
            <span class="input-group-text">
              <i class="fas fa-search"></i>
            </span>
            <input type="text" name="q" placeholder="Search tasks by title or description..." 
                   value="{{ q or '' }}" class="form-control" id="search-input">
          </div>
        </div>
        <div class="col-lg-3 col-md-6">
          <select name="status" class="form-select" id="status-filter">
            <option value="">üéØ All Status</option>
            <option value="Pending" {% if status == "Pending" %}selected{% endif %}>‚è≥ Pending</option>
            <option value="In Progress" {% if status == "In Progress" %}selected{% endif %}>üîÑ In Progress</option>
            <option value="Completed" {% if status == "Completed" %}selected{% endif %}>‚úÖ Completed</option>
          </select>
        </div>
        <div class="col-lg-2 col-md-6">
          <button type="submit" class="btn btn-primary w-100">
            <i class="fas fa-filter me-2"></i>Filter
          </button>
        </div>
        <div class="col-lg-2 col-md-6">
          <a href="/" class="btn btn-outline-secondary w-100">
            <i class="fas fa-times me-2"></i>Clear
          </a>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Quick Action Buttons -->
<div class="row mb-4">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
      <div>
        <h2 class="fw-bold text-primary mb-1">{{ page_title if page_title else "My Tasks" }} {% if current_user %}for {{ current_user.name }}{% endif %}</h2>
        <p class="text-muted mb-0">Stay organized and productive</p>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <a href="/tasks/new" class="btn btn-primary btn-lg">
          <i class="fas fa-plus me-2"></i>Add Task
        </a>
        {% if current_user %}
          <div class="btn-group" role="group">
            <a href="/shared-tasks" class="btn btn-info">
              <i class="fas fa-share-alt me-1"></i>Shared
            </a>
            <a href="/notifications" class="btn btn-warning">
              <i class="fas fa-bell me-1"></i>Alerts
            </a>
            <a href="/analytics" class="btn btn-success">
              <i class="fas fa-chart-bar me-1"></i>Analytics
            </a>
          </div>
          <a href="/logout" class="btn btn-outline-secondary">
            <i class="fas fa-sign-out-alt me-1"></i>Logout
          </a>
        {% else %}
          <a href="/login" class="btn btn-outline-primary btn-lg">
            <i class="fas fa-sign-in-alt me-2"></i>Login
          </a>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Progress Bar -->
{% if tasks %}
{% set completed = tasks | selectattr("status", "equalto", "Completed") | list %}
{% set in_progress = tasks | selectattr("status", "equalto", "In Progress") | list %}
{% set pending = tasks | selectattr("status", "equalto", "Pending") | list %}
{% set total = tasks|length %}
{% set progress = (completed|length / total * 100) if total > 0 else 0 %}
<div class="card mb-4">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h6 class="fw-bold mb-0">Task Progress Overview</h6>
      <span class="badge bg-primary fs-6">{{ total }} Total Tasks</span>
    </div>
    <div class="progress mb-3" style="height: 12px;">
      <div class="progress-bar bg-success" role="progressbar" style="width: {{ progress }}%;" data-bs-toggle="tooltip" title="{{ completed|length }} Completed">
      </div>
    </div>
    <div class="row text-center">
      <div class="col-4">
        <div class="text-success fw-bold">{{ completed|length }}</div>
        <small class="text-muted">Completed</small>
      </div>
      <div class="col-4">
        <div class="text-warning fw-bold">{{ in_progress|length }}</div>
        <small class="text-muted">In Progress</small>
      </div>
      <div class="col-4">
        <div class="text-secondary fw-bold">{{ pending|length }}</div>
        <small class="text-muted">Pending</small>
      </div>
    </div>
  </div>
</div>
{% endif %}



{% if tasks %}
<div class="table-responsive">
  <table class="table table-bordered table-striped">
    <thead class="table-dark">
      <tr>
        <th>Title</th>
        <th>Description</th>
        <th>Status</th>
        <th>Due Date</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for task in tasks %}
      <tr>
        <td><a href="/tasks/{{ task.id }}" class="text-decoration-none">{{ task.title }}</a></td>
        <td>{{ task.description if task.description else "No description" }}</td>
        <td>
          <span class="badge {% if task.status == 'Completed' %}bg-success{% elif task.status == 'In Progress' %}bg-warning{% else %}bg-secondary{% endif %}">
            {{ task.status }}
          </span>
        </td>
        <td>{{ task.due_date if task.due_date else "No due date" }}</td>
        <td>
          <div class="btn-group btn-group-sm" role="group">
            <a href="/tasks/{{ task.id }}" class="btn btn-outline-primary" title="View Details">
              <i class="fas fa-eye"></i>
            </a>
            <a href="/tasks/{{ task.id }}/edit" class="btn btn-outline-warning" title="Edit Task">
              <i class="fas fa-edit"></i>
            </a>
            <a href="/tasks/{{ task.id }}/share" class="btn btn-outline-info" title="Share Task">
              <i class="fas fa-share-alt"></i>
            </a>
            <a href="/tasks/{{ task.id }}/delete" class="btn btn-outline-danger" title="Delete Task">
              <i class="fas fa-trash"></i>
            </a>
          </div>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
{% else %}
<div class="text-center py-5">
  <div class="mb-4">
    <i class="fas fa-tasks" style="font-size: 4rem; color: #6c757d;"></i>
  </div>
  <h4 class="text-muted mb-3">No tasks yet</h4>
  <p class="text-muted mb-4">Create your first task to get started on your productivity journey!</p>
  <a href="/tasks/new" class="btn btn-primary btn-lg px-4">+ Create Your First Task</a>
</div>
{% endif %}

<!-- Performance and Interactivity Scripts -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Real-time search functionality
  const searchInput = document.getElementById('search-input');
  const statusFilter = document.getElementById('status-filter');
  const tableRows = document.querySelectorAll('#task-table tbody tr');
  
  function filterTasks() {
    const searchTerm = searchInput.value.toLowerCase();
    const selectedStatus = statusFilter.value;
    
    tableRows.forEach(row => {
      const title = row.cells[0].textContent.toLowerCase();
      const description = row.cells[1].textContent.toLowerCase();
      const status = row.cells[2].textContent.trim();
      
      const matchesSearch = title.includes(searchTerm) || description.includes(searchTerm);
      const matchesStatus = !selectedStatus || status.includes(selectedStatus);
      
      if (matchesSearch && matchesStatus) {
        row.style.display = '';
        row.classList.add('fade-in');
      } else {
        row.style.display = 'none';
        row.classList.remove('fade-in');
      }
    });
    
    // Update visible task count
    const visibleRows = Array.from(tableRows).filter(row => row.style.display !== 'none');
    const taskCountBadge = document.querySelector('.card-header .badge');
    if (taskCountBadge) {
      taskCountBadge.textContent = `${visibleRows.length} tasks`;
    }
  }
  
  // Debounced search to improve performance
  let searchTimeout;
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(filterTasks, 300);
  });
  
  statusFilter.addEventListener('change', filterTasks);
  
  // Enhanced button interactions
  document.querySelectorAll('.btn').forEach(btn => {
    btn.addEventListener('mouseenter', function() {
      this.style.transform = 'translateY(-2px)';
    });
    
    btn.addEventListener('mouseleave', function() {
      this.style.transform = 'translateY(0)';
    });
  });
  
  // Auto-submit search form when filters change
  const autoSubmitElements = [searchInput, statusFilter];
  autoSubmitElements.forEach(element => {
    element.addEventListener('change', function() {
      // Only auto-submit if user has typed something or selected a filter
      if (searchInput.value.length > 2 || statusFilter.value) {
        document.getElementById('search-form').submit();
      }
    });
  });
  
  // Initialize tooltips
  const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
  tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl);
  });
  
  // Add loading states to action buttons
  document.querySelectorAll('a[href*="/delete"]').forEach(btn => {
    btn.addEventListener('click', function(e) {
      if (confirm('Are you sure you want to delete this task?')) {
        this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Deleting...';
        this.classList.add('disabled');
      } else {
        e.preventDefault();
      }
    });
  });
  
  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    // Ctrl/Cmd + N for new task
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
      e.preventDefault();
      window.location.href = '/tasks/new';
    }
    
    // Escape to clear search
    if (e.key === 'Escape') {
      searchInput.value = '';
      statusFilter.value = '';
      filterTasks();
    }
    
    // Focus search with Ctrl/Cmd + F
    if ((e.ctrlKey || e.metaKey) && e.key === 'f') {
      e.preventDefault();
      searchInput.focus();
    }
  });
  
  // Progressive enhancement for table hover effects
  if (window.CSS && CSS.supports('transform', 'scale(1.02)')) {
    tableRows.forEach(row => {
      row.addEventListener('mouseenter', function() {
        this.style.transform = 'scale(1.02)';
        this.style.zIndex = '10';
      });
      
      row.addEventListener('mouseleave', function() {
        this.style.transform = 'scale(1)';
        this.style.zIndex = '1';
      });
    });
  }
  
  // Performance monitoring
  const observer = new PerformanceObserver((list) => {
    for (const entry of list.getEntries()) {
      if (entry.entryType === 'measure') {
        console.log(`${entry.name}: ${entry.duration}ms`);
      }
    }
  });
  observer.observe({ entryTypes: ['measure'] });
  
  // Measure initial page render time
  performance.mark('page-interactive');
  performance.measure('page-load-time', 'navigationStart', 'page-interactive');
});

// Service Worker for offline functionality (if supported)
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('/sw.js').then(function(registration) {
      console.log('SW registered: ', registration);
    }).catch(function(registrationError) {
      console.log('SW registration failed: ', registrationError);
    });
  });
}
</script>

{% endblock %}